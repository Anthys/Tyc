-- title:  game title
-- author: game developer
-- desc:   short description
-- script: lua

-- big sword has been stolen
-- take small sword, and retrieve it to restore stability to the Kingdom

-- the small sword is actually comically very big
-- the big sword is enormous, size of the tower
-- you have to climb a tower to find the big sword
-- each time a new type of enemy appears, it is introduced by a zoom and a vignette around it, its name appearing below it

-- game in top down hack slasher
-- when a panel is cleared, an arrow shows the direction toward which you have to continue

--game starts in a room with player in center, monster trying to enter everywhere
-- a wall breaks at the left, monster enters, an arrow blinks to push the player toward the right
-- the sword is in the middle of the next room,  the player can take it 

-- can choose capacities to use (like round), which changes the color of one side of the sword

function lerp(a,b,t) return (1-t)*a + t*b end
cos,sin,abs,atan2,sqrt=math.cos,math.sin,math.abs,math.atan2,math.sqrt
PI=math.pi 
t=0
tt=0
x=96
y=24
g={
	st=1
}

ST = {"intro", "begin"}
p={
	x=120,
	y=60,
	vx=0,
	vy=0,
	dir = {x=1,y=0},
	r=3,
	sw = {
		anim = {
			cd = 0,
			cdmax=1,
			active=false,
			frame=0,
			x0=0,
			y0=0,
			angle0=0,
			name="",
			oth1 = 0
		},
		x=120,
		y=60,
		lrp_p=.1,
		lrp_a=.06,
		angle=PI
	}
}

cam={
	x=0,
	y=0,
	tx=0,
	ty=0,
	lrp=.2
}

ents = {}

function TIC()
	_G[ST[g.st]]()
	t=t+1
	tt=tt+1
end

function intro()
	cls(0)
	print("big sword was stolen", 0, 0)
	if btnp(4) then g.st = 2 tt=0 end	
	if tt>30 then print("take small sword and retrieve big sword", 0, 10)
	if tt>60 then print("restore stability and save the world", 0, 20)
	if tt>90 then print("thks", 0, 30)
	if tt>120 then 	
		if tt%100<50 then print("press z", 100, 110, 1) end
	end end end end
end

function begin()
	cls()
	update_cam()
	--cam.x=p.x cam.y=p.y
	local ccx=cam.x//8--+(cam.x%8==0 and 1 or 0)
	local ccy=cam.y//8--+(cam.y%8==0 and 1 or 0)
	print(cam.x, 0,0)
	print(ccx, 0,10)
	map(ccx,ccy,31,18,-(cam.x%8),-(cam.y%8),0)

	if p.x < 240 and p.y < 120 then print("small sword ->", 120-cam.x, 60-cam.y) end

	draw_michel(cam.x,cam.y)
	draw_sword(cam.x,cam.y)

	actualise()
	process_input()
	--print(p.x, 0,0)
end

function update_cam()
	if p.x <240 and p.y < 120 then
		cam.tx=0 cam.ty = 0 cam.lrp = .3
	elseif p.x <240*2 and p.y < 120 then
		cam.tx=240 cam.ty=0 cam.lrp = .3
	else
		cam.lrp = .2
		cam.x=math.max(0,lerp(cam.x,p.x-120,cam.lrp))
		cam.y=math.max(0,lerp(cam.y,p.y-64,cam.lrp))
		return
	end
	cam.x = lerp(cam.x+.1, cam.tx, cam.lrp)
	cam.y = lerp(cam.y+.1, cam.ty, cam.lrp)
end

function process_input()
	if btn(0) then p.vy=-1 end
	if btn(1) then p.vy=1 end
	if btn(2) then p.vx=-1 end
	if btn(3) then p.vx=1 end

	if btnp(4) then anim_sword() end
end

rot = {
			0,-5,1,-5,2,-5,
						3,-4,
								4,-3,
									5,-2,
									5,-1,
									5,0,
									5,1,
									5,2,
								4,3,
						3,4,
	2,5,1,5,0,5,-1,5,-2,5,
						  -3,4,
						  	   -4,3,
									-5,2,
									-5,1,
									-5,0,
									-5,-1,
									-5,-2,
							    -4,-3,
						  -3,-4,
	-2,-5,-1,-5
						 
}

function draw_michel(cx,cy,debug)
	circ(p.x-cx, p.y-cy, p.r, 2)
	circb(p.x-cx, p.y-cy, p.r+1, 0)
	circb(p.x-cx,p.y-cy,p.r+2,3)
	local imax = ((p.sw.anim.cdmax-p.sw.anim.cd)/p.sw.anim.cdmax*27)//1
	for i=0,imax,1 do
		local idx = i*2+1
		pix(p.x+rot[idx]-cx,p.y+rot[idx+1]-cy,4)
	end
	if debug then line(p.x, p.y, p.x+p.dir.x*10,p.y+p.dir.y*10, 5) print(p.sw.angle, 0,0) 
		print(p.sw.anim.cd, 0,10)
		print(imax, 0,20)end
end

function actualise()
	--if not trymove(p,p.x,p.y,p.vx,p.vy,p.r,p.r) then 
	--if not trymove(p,p.x,p.y,0,p.vy,p.r,p.r) then
	--trymove(p,p.x,p.y,p.vx,0,p.r,p.r) end end 

	trymove(p,p.x,p.y,0,p.vy,p.r,p.r)
	trymove(p,p.x,p.y,p.vx,0,p.r,p.r)

	if (p.vx~=0 or p.vy~=0) then
		local norm = math.sqrt(p.vx^2+p.vy^2)
		p.dir.x = p.vx/norm
		p.dir.y=p.vy/norm
	end
	--p.vx=p.vx*.85
	--p.vy=p.vy*.85
	p.vx=0
	p.vy=0

	if not p.sw.anim.active then
		local a1 = math.atan2(p.dir.y, p.dir.x)-PI
		p.sw.angle = abs(-p.sw.angle+a1)<abs(PI*2-p.sw.angle+a1) and p.sw.angle or p.sw.angle-2*PI -- (p.sw.angle<0 and p.sw.angle+2*PI or p.sw.angle-2*PI)
		p.sw.angle = abs(-p.sw.angle+a1)<abs(-PI*2-p.sw.angle+a1) and p.sw.angle or p.sw.angle+2*PI
		--local trgt_angle = abs(-p.sw.angle+a1)>abs(PI*2-p.sw.angle+a1) and a1 or a1+2*PI
		local trgt_angle = a1
		p.sw.angle = lerp(p.sw.angle, trgt_angle, p.sw.lrp_a)
		p.sw.x = lerp(p.sw.x, p.x, p.sw.lrp_p)
		p.sw.y = lerp(p.sw.y, p.y, p.sw.lrp_p)
		if p.sw.anim.cd>0 then p.sw.anim.cd=p.sw.anim.cd-1 end
	else
		local sw = p.sw
		local anim = sw.anim
		local name = anim.name
		if name == "round" then
			local round_duration = 20
			if anim.frame > round_duration then anim.active = false anim.cd=200 anim.cdmax=200 return end
			if anim.frame == 0 then anim.oth1 = math.random(0,1)*2-1 end
			sw.angle = anim.frame/round_duration*2*PI*anim.oth1 + anim.angle0
			p.sw.x = lerp(p.sw.x, p.x, p.sw.lrp_p)
			p.sw.y = lerp(p.sw.y, p.y, p.sw.lrp_p)
			anim.frame=anim.frame+1
		end

	end
end

function sign(a)
	return a>=0 and 1 or -1
end

function trymove(obj,x,y,vx,vy,sx,sy) --rewrite with only obj?
	local xx = (x+vx+sign(vx)*sx)//8
	local yy = (y+vy+sign(vy)*sy)//8
	if mget(xx, yy) == 1 then 
		return false 
	else
		obj.x, obj.y = x+vx, y+vy 
		return true 
	end
end

function anim_sword(name)
	local sw = p.sw
	local anim = sw.anim
	if anim.active or anim.cd>0 then return end
	anim.active = true
	local name = "round"
	anim.name = name
	anim.frame = 0
	anim.angle0 = sw.angle
	anim.x0 = sw.x0
	anim.y0 = sw.y0
end

function draw_sword(cx,cy,border)
	local px = 120
	local py = 60
	local x0,y0,x1,y1,x2,y2,x3,y3,x4,y4,x5,y5,x6,y6,x7,y7,x8,y8,angle,a,b,c,d,e
	a,b,c,d,e=10,4,8,30,8
	angle = p.sw.angle

	x5,y5=p.sw.x,p.sw.y
	
	x4,y4 = x5+cos(angle)*a, y5+sin(angle)*a
	
	x6,y6=x4+cos(angle-PI/2)*(b+c/2),y4+sin(angle-PI/2)*(b+c/2)
	x3,y3=x4+cos(angle+PI/2)*(b+c/2),y4+sin(angle+PI/2)*(b+c/2)

	x2,y2=x4+cos(angle+PI/2)*(c/2),y4+sin(angle+PI/2)*(c/2)
	x7,y7=x4+cos(angle-PI/2)*(c/2),y4+sin(angle-PI/2)*(c/2)

	x1,y1=x2+cos(angle)*d,y2+sin(angle)*d
	x8,y8=x7+cos(angle)*d,y7+sin(angle)*d

	local dist = math.sqrt(e*e-c*c/4)
	x0,y0=(x1+x8)/2+cos(angle)*dist,(y1+y8)/2+sin(angle)*dist

	line(x5-cx,y5-cy,x4-cx,y4-cy,0)
	line(x3-cx,y3-cy,x6-cx,y6-cy,0)
	if border then
	line(x2,y2,x1,y1,3)
	line(x7,y7,x8,y8,3)
	line(x1,y1,x0,y0,4)
	line(x8,y8,x0,y0,4)
	else
		tri(x2-cx,y2-cy,x1-cx,y1-cy,x7-cx,y7-cy,15)
		tri(x7-cx,y7-cy,x8-cx,y8-cy,x1-cx,y1-cy,0)
		tri(x8-cx,y8-cy,x0-cx,y0-cy,x1-cx,y1-cy,0)
	end
	
end


--      x0 y0
-- x8 y8 / \ x1 y1
--       | |
--  x7y7 | | x2 y2
--x6 y6  ___ x3 y 3
--        | x4 y4
--      x5 y5

--      
--       / \ e
--       | |d
--       |c| 
--       ___ b
--        | a
--     
-- c is the length inside the sword, b is what is outside


-- <TILES>
-- 001:0443333042122111421112113212221231211111311212223221212202212220
-- 002:2222222222222222222222222222222222222222222222222222222222222222
-- 013:0000000000550000006660000606060006666550066555500566666666565566
-- 014:0000000000000000060060060666660606066666066606560666666566666666
-- 015:0000000000000000000000000000000000566600065606660606655666666655
-- </TILES>

-- <MAP>
-- 000:000000000000000000000000000000000000000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:000000000000000000000000000000000000000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:000000000000000000001010101010101010100000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:000000000000001010101020202020202020101010101000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:000000000000101020202020202020202020202020201000000000000000101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:000000000010102020202020202020202020202020201010000000000000101010000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000001010202020202020202020202020202020202010101010101010101010000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:000000101020202020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:000000102020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:000000102020202020202020202020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:000000101020202020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000001010202020202020202020202020202020202010101010101010101010000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000000010102020202020202020202020202020201010000000000000101010000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000101020202020202020202020202010100000000000000000101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000001010202020202020202010101010000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:000000000000000010101020202010101010000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:000000000000000000001010101000000000000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:000000000000000010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 019:000000000010101010202020202020201010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 020:000000001010202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 021:000000101020202020202020202020202020202010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 022:000010102020202020202020202020202020202020101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 023:001010202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 024:001020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 025:001020202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 026:001010202020202020202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 027:000010102020202020202020202020202020202020101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 028:000000101020202020202020202020202020202010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 029:000000001010202020202020202020202020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 030:000000000010102020202020202020101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 031:000000000000101010202020101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 032:000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

